<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>CodePen - Chat Widget</title>
  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css'><link rel="stylesheet" href="./style.css">

</head>
<body>
  <script>

    let socket

    let currconv
    let S = parseInt(prompt("who are you"))

    window.onload = function() {

      socket = new WebSocket("ws://localhost:8080/websock");

      socket.onopen = function(e) {
        console.log("[open] Connection established");
        // let id = prompt("what's your id? ")
        console.log("performing handshake");
        socket.send(S);
      };

      socket.onmessage = function(event) {
        console.log(`new data from server`);

        // console.log(currconv)

        // console.log(event.data)

        let reqData = JSON.parse(event.data)
        // console.log(reqData)

        if ( reqData.ConvId == currconv ) {
          drawMessage(reqData)
        } else {

        }
      };

      socket.onclose = function(event) {
      if (event.wasClean) {
        console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
      } else {
        // e.g. server process killed or network down
        // event.code is usually 1006 in this case
        console.log('[close] Connection died');
      }
      };

      socket.onerror = function(error) {
        console.log(`[error] ${error.message}`);
      };

      getConversation()

    }

    function getConversation() {
      var requestOptions = {
        method: 'GET',
        redirect: 'follow'
      };

      fetch(`http://localhost:8080/getconv?S=${S}`, requestOptions)
        .then(response => response.text())
        .then(result => populateConv(result))
        .catch(error => console.log('error', error));
    }


    function populateConv (reqdata) {

      let dataArr = JSON.parse(reqdata)

      if ( dataArr.code != 200 ) {
        console.log(dataArr.msg)
        return
      }

      dataArr.data.forEach(userData => {

        let pfp = "blank"

        if ( userData.pfp ) {
          pfp = userData.convId
        }

        document.getElementById("userbar").innerHTML += `<li class="clearfix" onclick="loadMessages('${userData.convId.toUpperCase()}')" >
            <img class="pfp" src="http://localhost/assets/${pfp}" alt="avatar" />
            <div class="about">
              <div class="name text-truncate" style="max-width: 132x;" id="name-${userData.convId}"></div>
              <div class="status text-truncate" style="max-width: 132px;" id="desc-${userData.convId}"></div>
            </div>
          </li>
        `

        document.getElementById("name-"+userData.convId).innerText = userData.name
        document.getElementById("desc-"+userData.convId).innerText = userData.description
      });

    }

    function loadMessages (convId) {

      var requestOptions = {
        method: 'GET',
        redirect: 'follow'
      };

      fetch(`http://localhost:8080/getsingleconv?S=${S}&convid=${convId}`, requestOptions)
        .then(response => response.text())
        .then(result => drawChat(result, convId))
        .catch(error => console.log('error', error));

      fetch(`http://localhost:8080/msg/read?S=${S}&convid=${convId}`, requestOptions)
        .then(response => response.text())
        .then(result => populateMess(result))
        .catch(error => console.log('error', error));
    }

    function drawChat(result, convId){

      currconv = convId

      document.getElementById("mainchatdiv"). innerHTML = `
        <div id="chatheader" class="chat-header clearfix">
          </div> <!-- end chat-header -->

          <div class="chat-history">
            <ul id="chatdiv">
            </ul>
          </div> <!-- end chat-history -->

          <div class="chat-message clearfix">
            <textarea name="message-to-send" id="message-to-send" placeholder ="Type your message" rows="3"></textarea>

            <i class="fa fa-file-o"></i> &nbsp;&nbsp;&nbsp;
            <i class="fa fa-file-image-o"></i>

            <button onclick="sendMessage('${convId.toUpperCase()}')" >Send <svg class="svg-icon" viewBox="0 0 20 20">
							<path d="M17.218,2.268L2.477,8.388C2.13,8.535,2.164,9.05,2.542,9.134L9.33,10.67l1.535,6.787c0.083,0.377,0.602,0.415,0.745,0.065l6.123-14.74C17.866,2.46,17.539,2.134,17.218,2.268 M3.92,8.641l11.772-4.89L9.535,9.909L3.92,8.641z M11.358,16.078l-1.268-5.613l6.157-6.157L11.358,16.078z"></path>
						</svg></button>

          </div> <!-- end chat-message -->`

      let dataJson = JSON.parse(result)
      let data = dataJson.data

      if ( dataJson.code != 200 ) {
        console.log(dataJson.msg)
        return
      }

      document.getElementById("chatheader").innerHTML = ""

      let pfp = "blank"

      if ( data.pfp ) {
        pfp = convId
      }

      document.getElementById("chatheader").innerHTML += `
      <img class="pfp" src="http://localhost/assets/${pfp}" alt="avatar" />

      <div class="chat-about">
        <div class="chat-with">${data.name}</div>
        <div class="chat-num-messages">${data.description}</div>
      </div>
      <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#friendRequestsModal" onclick=""><i class="fa fa-users" aria-hidden="true"></i></button>
      `

    }

    function populateMess(reqdata) {

      // document.getElementById("chatdiv").innerHTML = ""

      let dataArr = JSON.parse(reqdata)

      if ( dataArr.code != 200 ) {
        console.log(dataArr.msg)
        return
      }

      if ( dataArr.data == null ){
        return
      }

      dataArr.data.forEach(messData => {

        drawMessage(messData)

      });

    }

    function drawMessage (messData) {
      console.log(messData)
      var msg = ""

      if ( messData.UserId == S ) {
        msgStr = `
          <li class="clearfix">
            <div class="message-data align-right">
              <span class="message-data-time" id="time-${messData.Id}" ></span> &nbsp; &nbsp;
              <span class="message-data-name" id="name-${messData.Id}"></span> <i class="fa fa-circle me"></i>

            </div>
            <div class="message other-message float-right" id="mess-${messData.Id}">

            </div>
          </li>`
      } else {
        msgStr = `
        <li>
          <div class="message-data">
            <span class="message-data-name"><i class="fa fa-circle online"></i> <div id="name-${messData.Id}"> ${messData.Username} </div></span>
            <span class="message-data-time" id="time-${messData.Id}"></span>
          </div>
          <div class="message my-message" id="mess-${messData.Id}">

          </div>
        </li>`
      }

      document.getElementById("chatdiv").innerHTML += msgStr

      document.getElementById(`time-${messData.Id}`).innerText = messData.Time
      document.getElementById(`name-${messData.Id}`).innerText = messData.Username
      document.getElementById(`mess-${messData.Id}`).innerText = messData.Text
    }

    function sendMessage(convId) {

      var msg = document.getElementById("message-to-send").value

      document.getElementById("message-to-send").value = ""

      if ( !msg.replace(/\s/g, "") ) {
        return
      }

      var myHeaders = new Headers();
      myHeaders.append("Content-Type", "application/json");

      var raw = JSON.stringify({
        "s": S,
        "convid": convId,
        "text": msg
      });

      var requestOptions = {
        method: 'POST',
        headers: myHeaders,
        body: raw,
        redirect: 'follow'
      };

      fetch("http://localhost:8080/msg/send", requestOptions)
        .then(response => response.text())
        .then(result => console.log(result) )
        .catch(error => console.log('error', error));
    }

    function getFriendRequests(){
      var myHeaders = new Headers();

      var requestOptions = {
        method: 'GET',
        headers: myHeaders,
        redirect: 'follow'
      };

      fetch("http://localhost:8080/freq/getreq?S="+S, requestOptions)
        .then(response => response.text())
        .then(result => {
          console.log(result)
          let parsedData = JSON.parse(result)

          if ( parsedData.data == null ) {
            document.getElementById("freqs").innerText = "you have no friend requests"
            return
          }

          document.getElementById("freqs").innerHTML = ""

          parsedData.data.forEach(element => {
            // console.log(element)
            document.getElementById("freqs").innerHTML += `<div id="freq-${element.id}" class="col-9"> ${element.usr}
              <div class="btn-group col-3" role="group">
                <button type="button" onclick="accFriendRequests(${element.id}, true)" class="btn btn-success">accept</button>
                <button type="button" onclick="accFriendRequests(${element.id}, false)" class="btn btn-danger">reject</button>
              </div>
              </div>`
          });
        })
        .catch(error => console.log('error', error));
    }

    function sendFriendRequests(){
      let uid = parseInt(document.getElementById("Uid").value)
      var myHeaders = new Headers();
      // myHeaders.append("Authorization", "Bearer 8eFRkyFOkmHRqbbGNM78VEoGdVq9Voty9gFzWSYMQ1SVrt7uUQybtiRmeFFlPPuV");
      myHeaders.append("Content-Type", "application/json");

      var raw = JSON.stringify({
        "s": S,
        "userid": uid
      });

      var requestOptions = {
        method: 'POST',
        headers: myHeaders,
        body: raw,
        redirect: 'follow'
      };

      fetch("http://localhost:8080/freq/makereq", requestOptions)
        .then(response => response.text())
        .then(result => console.log(result))
        .catch(error => console.log('error', error));
    }

    function accFriendRequests(reqid, val){
      var myHeaders = new Headers();
      // myHeaders.append("Authorization", "Bearer 8eFRkyFOkmHRqbbGNM78VEoGdVq9Voty9gFzWSYMQ1SVrt7uUQybtiRmeFFlPPuV");
      myHeaders.append("Content-Type", "application/json");

      var raw = JSON.stringify({
        "s": S,
        "id": reqid,
        "accept": val
      });

      var requestOptions = {
        method: 'POST',
        headers: myHeaders,
        body: raw,
        redirect: 'follow'
      };

      fetch("http://localhost:8080/freq/accreq", requestOptions)
        .then(response => response.text())
        .then(result => {

          document.getElementById("freq-"+reqid).remove()

          if (val) {
            document.getElementById("userbar").innerHTML = ""
            getConversation()
          }
        })
        .catch(error => console.log('error', error));
    }
  </script>

<!-- partial:index.partial.html -->
<div class="chat-container clearfix">
    <div class="people-list" id="people-list">
      <!-- <div class="search">
        <input type="text" placeholder="search" />
        <i class="fa fa-search"></i>
      </div> -->
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
        <i class="fa fa-user" aria-hidden="true"></i>
      </button>

      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#friendRequestsModal" onclick="getFriendRequests()">
        <i class="fa fa-user-plus" aria-hidden="true"></i>
      </button>

      <ul id="userbar" class="list">
      </ul>
    </div>

    <div class="chat" id="mainchatdiv">


    </div> <!-- end chat -->

  </div> <!-- end container -->


  <!-- friendRequests modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

  <!-- Friend Requests Modal -->
  <div class="modal fade" id="friendRequestsModal" tabindex="-1" aria-labelledby="friendRequestsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="friendRequestsModalLabel">Friend Requests</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          Send friend request<br>
          <form class="d-flex" role="search" onsubmit="sendFriendRequests(); return false;">
            <input class="form-control me-2" type="search" id="Uid" placeholder="user id" aria-label="Search">
            <button class="btn btn-outline-success" type="submit">send</button>
          </form>

          <hr>

          Friend requests:

          <br>

          <div id="freqs">

          </div>

        </div>
      </div>
    </div>
  </div>

<!-- partial -->
  <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js'></script><script  src="./script.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
</body>
</html>
